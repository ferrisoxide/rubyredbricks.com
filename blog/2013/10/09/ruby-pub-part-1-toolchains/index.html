<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <title>Ruby Red Bricks - Ruby Pub - Part 1: Toolchains</title>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/blog/feed.xml" />
    <link href="/stylesheets/all.css" rel="stylesheet" />
  </head>
  <body>
    <div class="container">
      <div class="container-centered">
        <div class="banner">
          <div class="row">
            <div class="col-md-2">
              <a href="/">
                <img src="/images/avatar.png" class="image avatar">
              </a>
            </div>
            <div class="col-md-9">
              <a href="/">
                <h1>Ruby Red Bricks</h1>
              </a>
            </div>
          </div>
        </div>
        <div class="row"><hr class="jumbotron-hr"/></div>
        <div class="row post">
          <p><img alt="Ruby Pub" class="image left" src="/images/posts/ruby-pub.png" /></p>

<p>Part 1 of a series investigating the development of a Ruby-based e-Publishing system.</p>

<p>Before progressing too far in building a toolchain for publishing e-books, I want to have a look at the current state of the art - just to see what's out there and check that I'm not re-inventing the wheel.</p>

<!---->

<p>A surprising number of successful authors already use Ruby to drive their e-publishing toolchains. This post looks at a two of these systems: <a target="_blank" href="https://github.com/fnando/kitabu">Kitabu</a> and <a target="_blank" href="https://github.com/blueheadpublishing/bookshop">Bookshop</a>.</p>

<h2 id="kitabu">Kitabu</h2>

<p>Jesse Storimer uses Kitabu in the production of his <a target="_blank" href="http://www.jstorimer.com/pages/books">series of books</a> on working with low-level Unix sockets, TCP/IP and threads. He gives a more detailed explanation of how he uses Kitabu <a target="_blank" href="http://www.jstorimer.com/blogs/workingwithcode/7766061-my-ebook-publishing-process">on his blog</a> than I will go into here.</p>

<h3 id="installing-kitabu">Installing Kitabu</h3>

<p>Installing <a target="_blank" href="https://github.com/fnando/kitabu">Kitabu</a> is slightly complicated, due to its dependency (via the eeepub gem) on RubyZip. RubyZip's interface changed in version 1.0, so to be able to install Kitabu we have to make use of an earlier version of the gem.</p>

<p>To install Kitabu:</p>

<pre><code class="language-text">gem install rubyzip -v 0.9.9
gem install kitabu
</code></pre>

<p>As a side note, this also affects the <a target="_blank" href="https://github.com/ferrisoxide/tachypomp">Tachypomp</a> project.</p>

<p>Once installed Kitabu has some nice features. Executing <code>kitabu check</code> from the command line produces the following:</p>

<pre><code class="language-text">Prince XML: Converts HTML files into PDF files.
Not installed.

KindleGen: Converts ePub e-books into .mobi files.
Not installed.

html2text: Converts HTML documents into plain text.
Not installed.

pygments.rb: A generic syntax highlight. If installed, replaces CodeRay.
Not installed.
</code></pre>

<p>As the output suggests, Kitabu is capable of producing e-books in a variety of formats, including HTML, Kindle .mobi, PDF and text. PDF generation requires <a target="_blank" href="http://www.princexml.com/">Prince XML</a>, a commercial tool for building high-quality documents. At $495 USD for a single user licence, Prince isn't an inexpensive solution, but it does produce exceptional PDF documents. If your goal is to produce print-ready PDFs then investing in Prince shouldn't be too onerous.</p>

<p>It would be nice if Kitabu could default to an open-source PDF generator (<em>e.g.</em> Prawn) in the absence of Prince, but pretty much all PDF generating gems have their own interfaces and it'd be a lot of work to maintain support for both.</p>

<h3 id="working-with-kitabu">Working with Kitabu</h3>

<p>Kitabu works with Markdown, Textile or HTML formatted files. All the contents are maintained in the <code>/text</code> folder, indexed by the convention of adding a sequence number at the start of each filename (<em>e.g</em> <code>01_first_chapter.markdown</code>, <code>02_second_chapter.markdown</code>, â€¦). It's also possible to nest sections within chapters.</p>

<p>Running <code>kitabu new my_book_title</code> creates boilerplate layouts, templates, etc in the created <code>my_book_title</code> directory. There are various config files available to tweak, but that's beyond the scope of this post.</p>

<p>Kitabu's implementation of syntax highlighting is quite novel. Inline styling is supported by either CodeRay or Pygments, but Kitabu also allows you to declare references to code source files:</p>

<pre><code class="language-text">@@@ ruby code/example-1.rb @@@

In this example...
</code></pre>

<p>If you are working on a technical book this would probably prove handy, in that you can keep all your source code examples separate from the main text.</p>

<p>Another nice feature is <code>kitabu stats</code>. Running this command against the Tachypomp contents (ported to Kitabu) produced the following report:</p>

<pre><code class="language-text">Chapters: 8
Words: 34155
Images: 0
Links: 2
Footnotes: 0
Code blocks: 0
</code></pre>

<p>If you're wanting to keep tabs on your progress, I can see this being a handy feature.</p>

<p>Kitabu uses Sass under the hood to manage CSS. The ePub and HTML stylesheets are kept separate from each other in the <code>/templates</code> folder, allowing different styling for different representations of the content. This is a must, given ePub 2's limited support for CSS.</p>

<p>Kitabu has some built-in commands for generating content. For instance, the &lt;%= toc %&gt; will build a table of contents wherever declared. It may very well be possible to generate other common content using <code>erb</code>.</p>

<h3 id="exporting-content">Exporting Content</h3>

<p>Running <code>kitabu export</code> will build HTML and ePub versions of your content by default, and PDF and .mobi versions if you have the right gems installed. The output is a little terse (<code>** e-book has been exported</code>), but the content is generated cleanly in your book project's <code>/output</code> folder.</p>

<p>I'm not sure if I did something wrong, but running Tachypomp through Kitabu generated an ePub document with a garbled front page. Looking through the unzipped ePub file doesn't reveal anything, so I suspect this is an issue with Calibre not rendering .png files properly.</p>

<p>The generated HTML ends up being in a single page. While useful for debugging, I wouldn't want people to have to download an entire novel in one hit. Not sure if there's any way to change Kitabu's behaviour, but it doesn't seem likely. There's also no built-in mechanism for deploy HTML to a server, though writing a simple <code>rake</code> task wouldn't be too difficult.</p>

<p>Though I didn't install Prince or .mobi support, the <a target="_blank" href="https://github.com/fnando/kitabu#samples">sample documents</a> do show off its competent PDF generation capabilities.</p>

<h3 id="summary">Summary</h3>

<p>The framework isn't as extensible as either nanoc or Jekyll, but it's a purpose-built tool that does one thing well. Kitabu would be ideal as the main components of a publishing pipeline targeting off-line reading system like the Kindle or PDFs.</p>

<p>The inflexibility in managing HTML content, and the lack of nanoc-style filters to refine the generation of content, would drive me away from adopting Kitabu, but it's a nice and simple pipeline for producing e-books out of the box without having to write any custom code. Compared to <code>nanoc</code>, which requires a reasonable amount of configuration (e.g. the Rules file, custom commands) to get it to produce e-books, Kitabu assumes a sensible default model for e-book content.</p>

<p>In particular I like the <code>kitabu stats</code> command and would probably consider writing something similar as an extension to nanoc.</p>

<h2 id="bookshop">Bookshop</h2>

<p>Pat Shaughnessy wrote his <a target="_blank" href="http://patshaughnessy.net/ruby-under-a-microscope">Ruby Under the Microscope</a> using the <a target="_blank" href="https://github.com/blueheadpublishing/bookshop">Bookshop</a> gem.</p>

<p>As for Jesse Storimer, Pat does a <a target="_blank" href="http://patshaughnessy.net/2012/11/27/my-ebook-build-process-and-some-pdf-epub-and-mobi-tips">much better job than I</a> going through the ins and outs of using Bookshop. I will, however, endeavour to give it my best shot.</p>

<h3 id="installing-bookshop">Installing Bookshop</h3>

<p>Keeping the gem environment clean, so I don't pollute the common setup:</p>

<pre><code class="language-text">rvm use 1.9.3
rvm gemset use bookshop --create
gem install bookshop
</code></pre>

<p>I actually did something similar with Kitabu - I just neglected to mention it. Bookshop really seems to need <a target="_blank" href="http://www.princexml.com/">PrinceXML</a> installed before being able to do anything reasonable. On the Mac this is fairly straight forward. After downloading the <a target="_blank" href="http://www.princexml.com/download/">PrinceXML package</a> it's just a matter of unpacking the archive and running <code>/.install.sh</code>. Flawless. It doesn't matter if you install this before or after installing the Bookshop gem.</p>

<p>Bookshop required Java 1.5 or better installed, presumably to run <a target="_blank" href="https://code.google.com/p/epubcheck/">epubcheck</a> - a tool for validating ePub files.</p>

<h3 id="using-bookshop">Using Bookshop</h3>

<p>Building a basic outline for an e-book is simple:</p>

<pre><code class="language-text">bookshop new my_new_book
</code></pre>

<p>Bookshop is a much bigger beastie than Kitabu. The generated scaffolding is quite extensive, with a clean separation of content into <code>/frontmatter</code>, <code>/bodymatter</code> and <code>/backmatter</code> folders.</p>

<p>Bookshop uses HTML5 as the basis for generating content in different formats, not Markdownm and makes extensive use of <code>erb</code> to prepare the e-book text. It can also vary the generated content depending on the target format:</p>

<pre><code class="language-ruby">&lt;% if @output == (:pdf or :html) %&gt;
  &lt;%= import('frontmatter/cover.html.erb')%&gt;
&lt;% end %&gt;
</code></pre>

<p>While not as versatile as nanoc's representations, it certainly allows for variations in content between delivery formats. The <code>import</code> method is also interesting - you can organise your book in whatever files and folders suits you and pull the content in where appropriate. Because it's all <code>erb</code>-driven I imagine this would lend itself to reusing common content (<em>e.g.</em> copyright notices) or even a Rails-style templating system at a pinch. This is in contrast to the way I prefer to work, where a single source file is broken down using my <a target="_blank" href="https://github.com/ferrisoxide/breakdown">Breakdown gem</a>. But I can see this working for what is probably a more typical writing workflow.</p>

<p>Defining the table of contents is a little irksome. You have to build <code>toc.ncx.erb</code> (for ePub / .mobi) and <code>toc.html.erb</code> (for HTML5 / PDF) separately by hand. It would be nice to have a single metadata file - say a <code>contents.yml</code> - that defines the table of contents in the one place, and generate the required artefacts automatically.</p>

<h3 id="exporting-content-1">Exporting Content</h3>

<p>Running <code>bookshop build</code> gives a list of available formats and the location of build artefacts:</p>

<pre><code class="language-text">$ bookshop build

Usage: bookshop build [ARGS]

The most common build commands are:
 pdf          Builds a new pdf  at /builds/pdf/book.pdf
 html         Builds a new html at /builds/html/book.html
 epub         Builds a new epub at /builds/epub/book.epub
 mobi         Builds a new mobi at /builds/mobi/book.mobi
 all          Builds all formats above

All commands can be run with -h for more information.
</code></pre>

<p>As with Kitabu, the generated HTML ends up in a single file. Not particularly useful (at least to me), but the focus is very much on building content for offline delivery. Generating content in ePub format produces the following output:</p>

<pre><code class="language-text">$ bookshop build epub

Deleting any old builds
rm -r
cp -r book/epub/META-INF builds/epub/
cp -r book/epub/mimetype builds/epub/
Generating new html from erb
Generating new cover.html from erb
Generating new toc.html from erb
Generating new content.opf from erb
Generating new toc.ncx from erb
cp -r book/assets builds/epub/OEBPS/assets/
Zipping up into epub
  adding: mimetype (stored 0%)
  adding: META-INF/container.xml (deflated 32%)
  adding: OEBPS/assets/css/page-template.xpgt (deflated 78%)
  adding: OEBPS/assets/css/stylesheet.epub.css (deflated 65%)
  adding: OEBPS/images/canvas.jpg (deflated 0%)
  adding: OEBPS/images/cover.png (deflated 0%)
  adding: OEBPS/images/draft.png (deflated 6%)
  adding: OEBPS/images/html-18.png (deflated 2%)
  adding: OEBPS/book.html (deflated 59%)
  adding: OEBPS/content.opf (deflated 60%)
  adding: OEBPS/cover.html (deflated 34%)
  adding: OEBPS/toc.html (deflated 61%)
  adding: OEBPS/toc.ncx (deflated 70%)
Validating with epubcheck
Epubcheck Version 1.2
</code></pre>

<p>It interesting to note the <code>Validating with epubcheck</code> output. One nice feature of Bookshop is that it makes sure the generated content is valid ePub, something that Kitabu (and my own Tachypomp for that matter) trusts the eeepub gem to do for you. As it happens, I didn't suffer the same sort of weirdness generating ePub content that I did in Kitabu. Both systems created an image as part of the front page, with the Kitabu-generated front page seeming to scramble in Calibre. I didn't have any similar problems with Bookshop.</p>

<p>All the zipping is done with the Unix <code>zip</code> command. On Windows it's assumed that a <code>zip.exe</code> is available on the path. Bookshop doesn't use eeepub or any other gems for generating ePub 2 content. While there is more internal code to generate the ePub book, there's no reliance on third party gems like RubyZip.</p>

<p>Building a PDF file generates clean, print-ready documents - though it does require a commercial licence from Prince.</p>

<p>I didn't try creating a Kindle .mobi file, but as this just pipes the ePub contents through <a target="_blank" href="http://www.amazon.com/gp/feature.html?ie=UTF8&amp;docId=1000765211">Amazon's Kindlegem</a> executable I don't imagine there would be any real problems. I don't have a Kindle to test against, so I'm going to assume this just works.</p>

<h3 id="summary-1">Summary</h3>

<p>One major downside of Bookshop is that it is entirely driven by HTML5 - there doesn't seem to be any simple way to introduce Markdown or other alternative markup languages into the mix. There's also no mechanism to add additional formats (<em>e.g.</em> HPub). Having said that, the code is clean and easier to understand - it wouldn't take a massive effort to add either (hint: have a look at <code>/lib/bookshop/commands/build.rb</code>).</p>

<p>I really like the epubcheck integration. Knowing the generated content matches the ePub specification creates peace of mind. As a basic QA check I can't see any reason not to integrate this into a nanoc-based system.</p>

<h2 id="conclusion">Conclusion</h2>

<p>While both Kitabu and Bookshop do an admirable job of producing e-books in a variety of formats, I can't say I'm compelled to walk away from nanoc. The limited options for generating HTML content are probably fine in general, but doesn't support the online / offline publishing model I'm pursuing.</p>

<p>There's nothing either can do that can't be replicated in nanoc and - while it may require additional coding - I'd prefer the flexibility of a general purpose tool. There are a lot of good ideas in both systems examined, and I undoubtedly look to stealing some of these for my own system.</p>

<p>In short, I expect the majority of authors looking to produce content for offline readers would do well to look at either Kitabu (if your preference is for writing in Markdown) or Bookshop (for HTML based content).</p>

<p>In follow up posts I'll be looking at commercial e-publishing systems, examining how Ruby can be used to build an open source e-publishing system that takes written content all the way through to delivery, promotion and selling. And naturally enough I intend getting round to actually coding my own platform, building on what I've seen in Kitabu and Bookshop - and lessons learned from the <a href="/blog/2013/10/02/ruby-and-hpub/">Tachypomp</a> project.</p>

        </div>

          <div class="row"><hr/></div>
          <div class="row">
            <div id="disqus_thread"></div>
<script type="text/javascript">
//<![CDATA[
                  var disqus_shortname = 'rubyredbricks';
                        var disqus_url = 'http://rubyredbricks.com/blog/2013/10/09/ruby-pub-part-1-toolchains/';
          
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
//]]>
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

          </div>

        <div class="row"><hr/></div>

        <div class="row contact">
          <div class="col-md-5">
          <ul class="icons">
            <li>
              <a href="mailto:ferrisoxide@gmail.com" class="icon fa-envelope-o">
                <span class="fui-mail"></span>
              </a>
            </li>

            <li>
                <a href="https://github.com/ferrisoxide" class="icon fa-github" target="_blank">
                  <span class="fui-github"></span>
              </a>
            </li>

            <li>
                <a href="https://twitter.com/ferrisoxide" class="icon fa-twitter" target="_blank">
                  <span class="fui-twitter"></span>
                </a>
              </a>
            </li>

            <li>
              <a href="https://linkedin.com/in/ferrisoxide" class="icon fa-linkedin" target="_blank">
                <span class="fui-linkedin"></span>
              </a>
            </li>

            <li>
              <a href="https://plus.google.com/+TomTuddenham" class="icon fa-google-plus" target="_blank">
                <span class="fui-google-plus"></span>
              </a>
            </li>

            <li>
              <a href="https://www.facebook.com/tom.tuddenham.7" class="icon fa-facebook" target="_blank">
                <span class="fui-googleplus"></span>
              </a>
            </li>


          </ul>
        </div>
      </div>
      </div>
    </div>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-4121694-1', 'auto');
  ga('send', 'pageview');

</script>

  </body>
  <script src="/javascripts/all.js"></script>
</html>
